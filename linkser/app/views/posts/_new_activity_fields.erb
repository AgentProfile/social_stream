<%= f.text_field :text, :id => "input_activities", :size => 85 %>

<div id="link_preview" style="display:none;"></div>

<%= javascript_tag do %>
  $(function() {
    $("#input_activities").Watermark("<%= I18n.t('post.input') %>","#666");
    
    var urlDetect = function(){
      this.currentValue = $("#input_activities").val();
      if(this.lastValue==null) this.lastValue = "";
      
      var regexp = /(http|ftp|https):\/\/[\w-]+(\.[\w-]+)+([\w.,@?^=%&amp;:\/~+#-]*[\w@?^=%&amp;\/~+#-])?/
      if(regexp.test($("#input_activities").val())){
        if(this.currentValue!=this.lastValue){
          $("#link_preview").html("<%= escape_javascript(image_tag('loading.gif', :class => :loading)) %>");          
          this.lastValue = this.currentValue;
          var url = this.currentValue;
          var urlDetect = this;
          $.ajax({
            type : "GET",
            url : "<%= linkser_parse_url %>?url=" + url,
            success : function(html) {      
              console.log("Peticion guay a " + url);
              if ($("#input_activities").val()==url){ //Only show if input value is still the same
                $("#link_preview").html(html);
              console.log("Preview cambiada a " + url);
              }          
            },
            error: function (xhr, ajaxOptions, thrownError){ 
              $("#link_preview").html(url + "> PUM!");
              console.log("Error al pedir " + url);
              console.log(xhr.status);
              console.log(thrownError);
            }         
          });
        }
        $("#link_preview").show();
      }else{
        $("#link_preview").hide();
        $("#link_preview").html("");
      }
    }      
    $("#input_activities").change(urlDetect).keyup(urlDetect);
    
  });
  
<% end %>
